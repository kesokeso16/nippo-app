<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日報作成フォーム（アコーディオン対応＋ZIP保存）</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      margin: 0;
      max-width: 100%;
      box-sizing: border-box;
    }
    label, select, input, button, canvas {
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      width: auto;
      transform: scale(1.5);
      margin-right: 6px;
    }
    .accordion {
      background-color: #eee;
      color: #444;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      text-align: left;
      border: none;
      outline: none;
      font-size: 18px;
      transition: 0.4s;
      margin-top: 10px;
    }
    .accordion.active, .accordion:hover {
      background-color: #ccc;
    }
    .panel {
      padding: 0 18px;
      background-color: white;
      display: none;
      overflow: hidden;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    fieldset {
      border: none;
      padding: 0;
      margin: 10px 0;
    }
    canvas {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
    button {
      font-size: 18px;
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
    }
    button:hover {
      background: #45a049;
    }
    input[type="file"] {
      font-size: 14px;
    }
    .section label {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }
    .section input[type="text"] {
      margin-left: 8px;
      flex: 1;
    }
    .section label input[type="checkbox"] {
      margin-right: 6px;
    }
  </style>
</head>
<body>
<h1>日報作成フォームver3.11</h1>
<p>記入日：<span id="today"></span></p>
<label>物件名：
  <select id="propertySelect">
    <option value="">選択してください</option>
    <option value="物件A">物件A</option>
    <option value="物件B">物件B</option>
    <option value="その他">その他</option>
  </select>
  <input type="text" id="propertyInput" placeholder="直接入力も可">
</label>
<label>住所：<input type="text" id="address"></label>
<label>クライアント：
  <select id="clientSelect">
    <option value="">選択してください</option>
    <option value="クライアントA">クライアントA</option>
    <option value="クライアントB">クライアントB</option>
    <option value="その他">その他</option>
  </select>
  <input type="text" id="clientInput" placeholder="直接入力も可">
</label>
<fieldset>
  <legend>作業メンバー</legend>
  <label><input type="checkbox" name="worker" value="小串">小串</label>
  <label><input type="checkbox" name="worker" value="渡部">渡部</label>
  <label><input type="checkbox" name="worker" value="石川">石川</label>
  <label><input type="checkbox" name="worker" value="永田">永田</label>
  <label><input type="checkbox" name="worker" value="中尾">中尾</label>
  <label><input type="checkbox" name="worker" value="相良">相良</label>
  <label><input type="checkbox" name="worker" value="その他">その他</label>
  <input type="text" id="workerOther" placeholder="その他の場合入力">
</fieldset>
<label>作業時間：<input type="time" id="startTime">～<input type="time" id="endTime"></label>
<div id="sections"></div>
<label>画像添付：<input type="file" id="imageUpload" accept="image/*"></label>
<button onclick="generate()">日報をつくる</button>
<canvas id="canvas1" width="1240" height="1754"></canvas>
<button onclick="saveCanvas()">画像として保存</button>
<button onclick="downloadZip()">テキストと画像をZIPで保存</button>
<br><button onclick="submitToSheet()">フォームを送信</button>

<a id="downloadLink" style="display:none;"></a>
<script>
  document.getElementById("today").textContent = new Date().toLocaleDateString('ja-JP');
  const sectionContainer = document.getElementById("sections");
  const areas = {
    "玄関": ["壁・床・天井", "照明器具", "インターホン", "下駄箱", "ドア", "鍵シリンダー", "土間"],
    "台所": ["壁・床・天井", "窓サッシ", "カーテンレール", "水栓金具", "換気扇", "流し台", "ガスコンロ", "防熱版"],
    "洗面所": ["壁・床・天井", "照明器具", "洗面台", "鏡", "洗濯パン", "換気扇"],
    "浴室": ["壁・床・天井", "照明器具", "浴槽", "目地", "シャワーホース", "鏡", "換気扇", "ドア回り"],
    "トイレ": ["壁・床・天井", "照明器具", "便座", "水洗タンク", "換気扇", "ペーパーホルダー"],
    "各洋間": ["壁・床・天井", "窓サッシ", "網戸", "カーテンレール", "照明器具", "換気扇", "収納"],
    "各和室": ["壁・天井", "畳", "窓サッシ", "網戸", "カーテンレール", "照明器具", "換気扇", "収納"],
    "その他": ["エアコンヒーター", "エアコンスリーブ", "スイッチ", "コンセント", "タオル掛け", "給湯器", "ベランダ", "バルコニー", "物干しかけ"]
  };
  const workers = ["小串", "渡部", "石川", "永田", "中尾", "相良", "その他"];
  for (let [area, items] of Object.entries(areas)) {
    const accBtn = document.createElement("button");
    accBtn.className = "accordion";
    accBtn.textContent = area;
    const panel = document.createElement("div");
    panel.className = "panel section";
    const workerHTML = workers.map(w => w === "その他" ? `<label><input type="checkbox" name="${area}_worker" value="${w}">${w}<input type="text" id="${area}_other" placeholder="名前"></label>` : `<label><input type="checkbox" name="${area}_worker" value="${w}">${w}</label>`).join(" ");
    const itemHTML = items.map(item => `<label><input type="checkbox" name="${area}_check" value="${item}">${item}</label>`).join(" ");
    panel.innerHTML = `<div><strong>担当者：</strong><br>${workerHTML}</div><br><div><strong>チェック項目：</strong><br>${itemHTML}</div>`;
    sectionContainer.appendChild(accBtn);
    sectionContainer.appendChild(panel);
  }
  document.querySelectorAll(".accordion").forEach(btn => {
    btn.addEventListener("click", function () {
      this.classList.toggle("active");
      const panel = this.nextElementSibling;
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    });
  });

  function generate() {
    const canvas = document.getElementById("canvas1");
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "black";
    ctx.font = "24px sans-serif";

    const date = new Date().toLocaleDateString("ja-JP");
    let y = 40;
    ctx.fillText(`日付: ${date}`, 50, y); y += 40;

    const property = document.getElementById("propertyInput").value || document.getElementById("propertySelect").value;
    ctx.fillText(`物件名: ${property}`, 50, y); y += 40;

    const address = document.getElementById("address").value;
    ctx.fillText(`住所: ${address}`, 50, y); y += 40;

    const client = document.getElementById("clientInput").value || document.getElementById("clientSelect").value;
    ctx.fillText(`クライアント: ${client}`, 50, y); y += 40;

    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;
    ctx.fillText(`作業時間: ${start} ～ ${end}`, 50, y); y += 40;

    const workers = [...document.querySelectorAll('input[name="worker"]:checked')].map(cb => cb.value);
    const workerOther = document.getElementById("workerOther").value;
    if (workers.includes("その他") && workerOther) workers[workers.indexOf("その他")] = workerOther;
    ctx.fillText(`作業メンバー: ${workers.join(", ")}`, 50, y); y += 40;

    for (let [area, _] of Object.entries(areas)) {
      const checkboxes = document.querySelectorAll(`input[name="${area}_check"]:checked`);
      const checks = [...checkboxes].map(cb => cb.value);
      const workerBoxes = document.querySelectorAll(`input[name="${area}_worker"]:checked`);
      let areaWorkers = [...workerBoxes].map(cb => {
        if (cb.value === "その他") {
          const otherVal = document.getElementById(`${area}_other`).value;
          return otherVal || "その他";
        }
        return cb.value;
      });
      if (checks.length || areaWorkers.length) {
        ctx.fillText(`【${area}】`, 50, y); y += 30;
        if (areaWorkers.length) {
          ctx.fillText(` 担当: ${areaWorkers.join(", ")}`, 70, y); y += 30;
        }
        if (checks.length) {
          ctx.fillText(` チェック: ${checks.join(", ")}`, 70, y); y += 30;
        }
      }
      // ↓ ZIP作成後の直後とかに挿入してOK
const postData = {
  property: prop,
  address: address,
  client: client,
  startTime: start,
  endTime: end,
  members: Array.from(document.querySelectorAll("input[name='worker']:checked"))
                .map(cb => cb.value).join(", "),
  sections: Object.keys(areas).map(area => {
    const data = getAreaData(area);
    return data.workers || data.items ? `${data.area}：${data.workers}／${data.items}` : '';
  }).filter(Boolean).join("\n")
};

fetch("https://script.google.com/macros/s/AKfycbyuiuF-ME_z8YmVZdHchMde3XZO8jCGTWFtYaryW3tPGomLTv_SJ6qvkBzKpl66mhMPvQ/exec", {
  method: "POST",
  body: JSON.stringify(postData),
  headers: {
    "Content-Type": "application/json"
  }
}).then(res => res.text()).then(txt => {
  console.log("GAS応答:", txt);
});

    }

    const fileInput = document.getElementById("imageUpload");
    if (fileInput.files.length > 0) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          ctx.drawImage(img, 50, y + 20, 300, 200);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(fileInput.files[0]);
    }
  }

  function saveCanvas() {
    const canvas = document.getElementById("canvas1");
    canvas.toBlob(blob => {
      saveAs(blob, "nippo_image.png");
    });
  }

  function downloadZip() {
    const zip = new JSZip();
    const canvas = document.getElementById("canvas1");
    canvas.toBlob(blob => {
      zip.file("nippo_image.png", blob);
      const text = `物件名: ${document.getElementById("propertyInput").value || document.getElementById("propertySelect").value}\n住所: ${document.getElementById("address").value}\nクライアント: ${document.getElementById("clientInput").value || document.getElementById("clientSelect").value}`;
      zip.file("nippo.txt", text);
      zip.generateAsync({ type: "blob" }).then(content => {
        saveAs(content, `${new Date().toLocaleDateString('ja-JP')}_nippo.zip`);
      });
    });
  }


  // PWA：Service Worker登録
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg))
        .catch(err => console.error('Service Worker registration failed:', err));
    });
  }
  function submitToSheet() {
  const prop = document.getElementById("propertyInput").value || document.getElementById("propertySelect").value;
  const client = document.getElementById("clientInput").value || document.getElementById("clientSelect").value;
  const address = document.getElementById("address").value;
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;

  const members = Array.from(document.querySelectorAll("input[name='worker']:checked"))
                      .map(cb => cb.value).join(", ");

  const sectionsData = Object.keys(areas).map(area => {
    const data = getAreaData(area);
    return data.workers || data.items ? `${data.area}：${data.workers}／${data.items}` : '';
  }).filter(Boolean).join("\n");

  const postData = {
    property: prop,
    address: address,
    client: client,
    startTime: start,
    endTime: end,
    members: members,
    sections: sectionsData
  };

  fetch("https://script.google.com/macros/s/AKfycbyuiuF-ME_z8YmVZdHchMde3XZO8jCGTWFtYaryW3tPGomLTv_SJ6qvkBzKpl66mhMPvQ", {
    method: "POST",
    body: JSON.stringify(postData),
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(res => res.text())
  .then(txt => {
    alert("送信完了しました！");
    console.log("GAS応答:", txt);
    document.querySelector("form").reset();
  })
  .catch(err => {
    alert("送信に失敗しました：" + err);
    console.error(err);
  });
}
function getAreaData(area) {
  const workerBoxes = document.querySelectorAll(`input[name="${area}_worker"]:checked`);
  const itemBoxes = document.querySelectorAll(`input[name="${area}_check"]:checked`);
  const workers = Array.from(workerBoxes).map(cb => {
    if (cb.value === "その他") {
      const val = document.getElementById(`${area}_other`).value;
      return val || "その他";
    }
    return cb.value;
  }).join(", ");
  const items = Array.from(itemBoxes).map(cb => cb.value).join(", ");
  return { area, workers, items };
}
</script>
</body>
</html>

